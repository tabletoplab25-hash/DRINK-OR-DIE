<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drink or Die</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(135deg, #1a0f2e 0%, #2d1b4e 50%, #1e293b 100%);
            min-height: 100vh;
            color: #fbbf24;
            overflow-x: hidden;
        }
        
        .bg-effect {
            position: fixed;
            width: 500px;
            height: 500px;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.15;
            pointer-events: none;
            animation: pulse 4s ease-in-out infinite;
        }
        
        .bg-effect-1 {
            top: -100px;
            left: -100px;
            background: #9333ea;
        }
        
        .bg-effect-2 {
            bottom: -100px;
            right: -100px;
            background: #f59e0b;
            animation-delay: 2s;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.15; }
            50% { transform: scale(1.2); opacity: 0.25; }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        h1 {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            text-align: center;
            margin: 20px 0;
            background: linear-gradient(135deg, #fbbf24, #fcd34d, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
        }
        
        .setup-screen {
            max-width: 600px;
            margin: 50px auto;
            background: rgba(30, 27, 75, 0.6);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(251, 191, 36, 0.3);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .setup-screen h2 {
            text-align: center;
            color: #fcd34d;
            margin-bottom: 30px;
            font-size: 2rem;
        }
        
        .player-select {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .player-select button {
            flex: 1;
            padding: 15px;
            border: 2px solid rgba(251, 191, 36, 0.3);
            background: rgba(30, 27, 75, 0.5);
            color: #fbbf24;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .player-select button:hover {
            background: rgba(251, 191, 36, 0.2);
            transform: scale(1.05);
        }
        
        .player-select button.selected {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1a0f2e;
            border-color: #fcd34d;
            box-shadow: 0 5px 20px rgba(251, 191, 36, 0.4);
        }
        
        .start-button {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1a0f2e;
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(251, 191, 36, 0.4);
        }
        
        .start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(251, 191, 36, 0.6);
        }
        
        .game-info {
            text-align: center;
            margin: 20px 0;
            font-size: 1.2rem;
        }
        
        .message {
            background: rgba(147, 51, 234, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid rgba(147, 51, 234, 0.5);
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .player-card {
            background: rgba(30, 27, 75, 0.5);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(100, 100, 120, 0.3);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .player-card.active {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.15);
            box-shadow: 0 5px 20px rgba(251, 191, 36, 0.3);
        }
        
        .player-card.selected-target {
            border-color: #fcd34d;
            background: rgba(252, 211, 77, 0.2);
            box-shadow: 0 0 30px rgba(252, 211, 77, 0.5);
            animation: glow 1s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(252, 211, 77, 0.5); }
            50% { box-shadow: 0 0 40px rgba(252, 211, 77, 0.8); }
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .player-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #fcd34d;
        }
        
        .player-health {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
        }
        
        .cards-container {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .potion-card {
            width: 70px;
            height: 100px;
            border-radius: 10px;
            border: 2px solid rgba(251, 191, 36, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .potion-card:hover {
            transform: scale(1.1) translateY(-5px);
        }
        
        .potion-card.selected {
            border-color: #fcd34d;
            border-width: 3px;
            box-shadow: 0 0 20px rgba(252, 211, 77, 0.8);
            transform: scale(1.15) translateY(-8px);
        }
        
        .potion-card.highlighted {
            border-color: #10b981;
            border-width: 3px;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
        }
        
        .potion-card.back {
            background: linear-gradient(135deg, #4c1d95, #2e1065);
            color: rgba(251, 191, 36, 0.4);
        }
        
        .potion-card.empty {
            background: linear-gradient(135deg, #64748b, #475569);
            color: #fff;
        }
        
        .potion-card.poison {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            color: #fff;
        }
        
        .potion-card.deadly {
            background: linear-gradient(135deg, #dc2626, #7f1d1d);
            color: #fff;
        }
        
        .potion-card.healing {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1a0f2e;
        }
        
        .card-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .card-label {
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .card-value {
            font-size: 1rem;
            font-weight: bold;
            margin-top: 3px;
        }
        
        .card-position {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.8rem;
            opacity: 0.6;
        }
        
        .player-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: rgba(251, 191, 36, 0.7);
        }
        
        .action-panel {
            background: rgba(30, 27, 75, 0.7);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(251, 191, 36, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .action-panel h3 {
            color: #fcd34d;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            padding: 15px 25px;
            border: 2px solid rgba(251, 191, 36, 0.3);
            background: rgba(30, 27, 75, 0.5);
            color: #fbbf24;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover:not(:disabled) {
            background: rgba(251, 191, 36, 0.2);
            transform: scale(1.05);
            border-color: #fcd34d;
        }
        
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1a0f2e;
            border: none;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #fcd34d, #fbbf24);
            box-shadow: 0 5px 20px rgba(251, 191, 36, 0.5);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e1b4b, #2d1b4e);
            border: 2px solid #fbbf24;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }
        
        .modal-content h2 {
            color: #fcd34d;
            margin-bottom: 25px;
            font-size: 2rem;
            text-align: center;
        }
        
        .clue-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .clue-option {
            padding: 20px;
            background: rgba(30, 27, 75, 0.5);
            border: 2px solid rgba(251, 191, 36, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .clue-option:hover {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fcd34d;
            transform: scale(1.02);
        }
        
        .clue-option-title {
            font-weight: bold;
            color: #fcd34d;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .clue-option-desc {
            color: rgba(251, 191, 36, 0.7);
            font-size: 0.9rem;
        }
        
        .position-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        
        .position-btn {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            border: 2px solid rgba(251, 191, 36, 0.3);
            background: rgba(30, 27, 75, 0.5);
            color: #fbbf24;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .position-btn:hover {
            background: rgba(251, 191, 36, 0.2);
        }
        
        .position-btn.selected {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1a0f2e;
            border-color: #fcd34d;
        }
        
        .gadgets-section {
            background: rgba(91, 33, 182, 0.2);
            border: 2px solid rgba(124, 58, 237, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .gadgets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .gadget-card {
            background: rgba(30, 27, 75, 0.5);
            border: 2px solid rgba(124, 58, 237, 0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .gadget-card.selectable {
            cursor: pointer;
        }
        
        .gadget-card.selectable:hover {
            transform: scale(1.05);
            border-color: #a78bfa;
            background: rgba(124, 58, 237, 0.3);
        }
        
        .gadget-card.usable {
            cursor: pointer;
            border-color: #10b981;
        }
        
        .gadget-card.usable:hover {
            transform: scale(1.1);
            border-color: #34d399;
            background: rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }
        
        .gadget-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .gadget-name {
            font-weight: bold;
            color: #a78bfa;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .gadget-desc {
            font-size: 0.75rem;
            color: rgba(251, 191, 36, 0.6);
        }
        
        .log {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(100, 100, 120, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            color: rgba(251, 191, 36, 0.6);
            font-size: 0.85rem;
            margin: 5px 0;
        }
        
        .instructions {
            background: rgba(30, 27, 75, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }
        
        .instructions h4 {
            color: #fcd34d;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            list-style-position: inside;
            color: rgba(251, 191, 36, 0.8);
            font-size: 0.9rem;
        }
        
        .instructions li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="bg-effect bg-effect-1"></div>
    <div class="bg-effect bg-effect-2"></div>
    
    <div class="container">
        <!-- Setup Screen -->
        <div id="setup-screen" class="setup-screen">
            <h1>üç∑ Drink or Die üíÄ</h1>
            
            <div class="instructions">
                <h4>How to Play:</h4>
                <ul>
                    <li>Each player set (10 cards) goes into a common deck</li>
                    <li>Deck is shuffled and 5 cards dealt randomly per turn</li>
                    <li><strong>FREE CLUE:</strong> At turn start, see your hand quality</li>
                    <li>You'll see: Very Positive, Positive, Neutral, Negative, or Very Negative</li>
                    <li>Others see your cards, you don't see yours!</li>
                    <li><strong>4 clue tokens</strong> per round to learn about your hand</li>
                    <li><span style="color:#64748b">Empty</span> = 0 pts + receiver gets gadget</li>
                    <li><span style="color:#7c3aed">Poison</span> = -1 pt</li>
                    <li><span style="color:#dc2626">Deadly Poison</span> = -3 pts üíÄ</li>
                    <li><span style="color:#fbbf24">Healing</span> = +2 pts</li>
                    <li><strong>Gadgets:</strong> Distiller ‚öóÔ∏è, Amplifier ‚ö°, Catalyst üí•, Swap üîÑ, Reflect ü™û, Breaker ‚ùå, Double Turn ‚è©, Immuno üõ°Ô∏è</li>
                    <li>Place gadgets face-down before card revealed!</li>
                    <li><strong>2 rounds, 2 turns each.</strong> Highest score wins!</li>
                </ul>
            </div>
            
            <h2>Select Number of Players</h2>
            <div class="player-select">
                <button onclick="selectPlayers(2)" data-players="2">2</button>
                <button onclick="selectPlayers(3)" data-players="3">3</button>
                <button onclick="selectPlayers(4)" data-players="4">4</button>
                <button onclick="selectPlayers(5)" data-players="5">5</button>
                <button onclick="selectPlayers(6)" data-players="6">6</button>
            </div>
            
            <button class="start-button" onclick="startGame()">Begin the Ritual</button>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" style="display: none;">
            <h1>üç∑ Drink or Die üíÄ</h1>
            
            <div class="game-info">
                <div>Round <span id="current-round">1</span>/3 ‚Ä¢ Turn <span id="current-turn">1</span>/2</div>
                <div class="message" id="message">Your turn!</div>
            </div>
            
            <div id="players-container" class="players-grid"></div>
            
            <div id="action-panel" class="action-panel" style="display: none;">
                <h3>Your Turn</h3>
                <div class="action-buttons">
                    <button class="btn" onclick="openClueModal()" id="clue-btn">
                        Ask Clue (<span id="clues-remaining">3</span>/3)
                    </button>
                    <button class="btn btn-primary" onclick="givePotion()" id="give-btn" disabled>
                        Give Potion
                    </button>
                </div>
                <div style="margin-top: 15px; text-align: center; color: rgba(251, 191, 36, 0.7);" id="action-hint">
                    ‚Üí Select a target player
                </div>
            </div>
            
            <div id="gadgets-section" class="gadgets-section" style="display: none;">
                <h3 style="color: #a78bfa; margin-bottom: 10px;">Your Gadgets</h3>
                <div id="gadgets-container" class="gadgets-grid"></div>
            </div>
            
            <div class="log">
                <h4 style="color: #64748b; margin-bottom: 10px; font-size: 0.9rem;">Game Log:</h4>
                <div id="log-container"></div>
            </div>
        </div>
    </div>
    
    <!-- Clue Modal -->
    <div id="clue-modal" class="modal">
        <div class="modal-content">
            <h2>Ask a Clue</h2>
            <div id="clue-step-1" class="clue-options">
                <div class="clue-option" onclick="selectClueType('quality')">
                    <div class="clue-option-title">Check Hand Quality</div>
                    <div class="clue-option-desc">What's the overall quality of your hand?</div>
                </div>
                <div class="clue-option" onclick="selectClueType('single')">
                    <div class="clue-option-title">Check Single Card</div>
                    <div class="clue-option-desc">Is a specific card empty or potion?</div>
                </div>
                <div class="clue-option" onclick="selectClueType('compare')">
                    <div class="clue-option-title">Compare Two Cards</div>
                    <div class="clue-option-desc">Are two cards the same type?</div>
                </div>
                <button class="btn" onclick="closeClueModal()" style="margin-top: 10px; width: 100%;">Cancel</button>
            </div>
            
            <div id="clue-step-2" style="display: none;">
                <div id="clue-instruction" style="color: #fcd34d; margin-bottom: 15px; text-align: center;"></div>
                <div class="position-selector" id="position-selector-1"></div>
                <div class="position-selector" id="position-selector-2" style="display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn" onclick="backToClueType()" style="flex: 1;">Back</button>
                    <button class="btn btn-primary" onclick="confirmClue()" id="confirm-clue-btn" style="flex: 1;">Confirm</button>
                </div>
            </div>
            
            <div id="clue-answer" style="display: none; text-align: center;">
                <div style="font-size: 2rem; margin: 20px 0;">üìú</div>
                <div style="font-size: 1.3rem; color: #fcd34d; margin: 20px 0;" id="clue-answer-text"></div>
                <button class="btn btn-primary" onclick="closeClueModal()" style="width: 100%;">Continue</button>
            </div>
        </div>
    </div>
    
    <!-- Gadget Selection Modal -->
    <div id="gadget-modal" class="modal">
        <div class="modal-content">
            <h2>Choose Your Gadget!</h2>
            <div class="gadgets-grid" id="gadget-selection"></div>
        </div>
    </div>
    
    <!-- Round End Modal -->
    <div id="round-end-modal" class="modal">
        <div class="modal-content">
            <h2>Round <span id="round-number">1</span> Complete!</h2>
            <div id="round-scores" style="margin: 30px 0;"></div>
            <button class="btn btn-primary" onclick="nextRound()" style="width: 100%;">Continue to Next Round</button>
        </div>
    </div>
    
    <!-- Game End Modal -->
    <div id="game-end-modal" class="modal">
        <div class="modal-content">
            <div style="text-align: center; font-size: 4rem; margin-bottom: 20px;">üëë</div>
            <h2>Game Over!</h2>
            <div id="final-scores" style="margin: 30px 0;"></div>
            <button class="btn btn-primary" onclick="location.reload()" style="width: 100%;">Play Again</button>
        </div>
    </div>
    
    <!-- Card Reveal Modal -->
    <div id="card-reveal-modal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h2 style="margin-bottom: 20px;" id="reveal-title">Card Revealed!</h2>
            <div style="display: flex; justify-content: center; margin: 30px 0;">
                <div id="revealed-card" style="transform: scale(1.5);"></div>
            </div>
            <div id="reveal-effect" style="font-size: 1.5rem; margin: 20px 0; color: #fcd34d; font-weight: bold;"></div>
            <button class="btn btn-primary" onclick="closeCardReveal()" style="width: 100%; margin-top: 20px;">Continue</button>
        </div>
    </div>
    
    <!-- Gadget Use Modal -->
    <div id="gadget-use-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 style="margin-bottom: 10px;" id="gadget-use-title">Use a Gadget?</h2>
            <p style="color: #fcd34d; margin-bottom: 20px;" id="gadget-use-subtitle">You can use one gadget before the card is revealed</p>
            <div class="gadgets-grid" id="gadget-use-options"></div>
            <button class="btn" onclick="skipGadgetPlacement()" style="width: 100%; margin-top: 15px;">Skip / No Gadget</button>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            numPlayers: 2,
            players: [],
            currentPlayerIndex: 0,
            currentRound: 1,
            currentTurn: 1,
            deck: [],
            usedDeck: [],
            selectedCardIndex: null,
            selectedTarget: null,
            clueType: null,
            cluePos1: null,
            cluePos2: null,
            pendingReveal: null,
            pendingAction: null
        };
        
        const MAX_ROUNDS = 2; // Changed from 3 to 2
        
        const CARD_TYPES = {
            EMPTY: 'empty',
            POISON: 'poison',
            DEADLY: 'deadly',
            HEALING: 'healing'
        };
        
        const CARD_VALUES = {
            empty: 0,
            poison: -1,
            deadly: -3,
            healing: 2
        };
        
        const GADGETS = [
            { id: 'distiller', name: 'Distiller', desc: 'Discard the card, no target', icon: '‚öóÔ∏è', priority: 3 },
            { id: 'amplifier', name: 'Amplifier', desc: 'Double effect (-2/-6/+4)', icon: '‚ö°', priority: 4 },
            { id: 'catalyst', name: 'Catalyst', desc: 'Hit another player of your choice', icon: 'üí•', priority: 4 },
            { id: 'swap', name: 'Swap', desc: 'Exchange with first card from deck', icon: 'üîÑ', priority: 2 },
            { id: 'reflect', name: 'Reflect', desc: 'Send back to giver', icon: 'ü™û', priority: 4 },
            { id: 'breaker', name: 'Gadget Breaker', desc: 'Destroy all other gadgets', icon: '‚ùå', priority: 1 },
            { id: 'double-turn', name: 'Double Turn', desc: 'Take 2 consecutive turns', icon: '‚è©', priority: 5 },
            { id: 'immuno', name: 'Immuno-Defensive', desc: 'Negative = 0, Positive = +1', icon: 'üõ°Ô∏è', priority: 4 }
        ];
        
        // Setup Functions
        function selectPlayers(num) {
            gameState.numPlayers = num;
            document.querySelectorAll('.player-select button').forEach(btn => {
                btn.classList.remove('selected');
                if (parseInt(btn.dataset.players) === num) {
                    btn.classList.add('selected');
                }
            });
        }
        
        function createDeck() {
            // Create one set of 10 cards per player
            const singleSet = [
                ...Array(5).fill('empty'),
                ...Array(2).fill('poison'),
                ...Array(1).fill('deadly'),  // New deadly poison -3
                ...Array(2).fill('healing')
            ];
            
            // Multiply by number of players
            const fullDeck = [];
            for (let i = 0; i < gameState.numPlayers; i++) {
                fullDeck.push(...singleSet);
            }
            
            // Shuffle
            return fullDeck.sort(() => Math.random() - 0.5);
        }
        
        function startGame() {
            gameState.players = Array.from({ length: gameState.numPlayers }, (_, i) => ({
                id: i,
                name: i === 0 ? 'You' : `AI ${i}`,
                isAI: i !== 0,
                health: 0,
                hand: [],
                gadgets: [],
                clueTokens: [true, true, true, true], // 4 clue tokens
                initialTotal: 0
            }));
            
            // Single shared deck - distribute 5 cards to each player
            dealNewHands();
            
            gameState.currentPlayerIndex = 0;
            
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            renderGame();
            addLog('Game started! Round 1 begins.');
            announcePlayerPotions();
        }
        
        function dealNewHands() {
            // Create and shuffle a fresh deck (10 cards √ó numPlayers)
            const deck = createDeck();
            
            // Deal 5 cards to each player
            gameState.players.forEach((player, i) => {
                player.hand = deck.slice(i * 5, (i + 1) * 5);
            });
            
            // Remaining cards stay in deck (though there shouldn't be any if everyone gets 5)
            gameState.deck = deck.slice(gameState.numPlayers * 5);
        }
        
        function announcePlayerPotions() {
            // Tell each player the QUALITATIVE range of their card values
            gameState.players.forEach(player => {
                const totalValue = player.hand.reduce((sum, card) => sum + CARD_VALUES[card], 0);
                
                // Store initial total for display (won't change during turn)
                player.initialTotal = totalValue;
                
                let range;
                if (totalValue >= 3) {
                    range = "Very Positive";
                } else if (totalValue >= 1) {
                    range = "Positive";
                } else if (totalValue === 0) {
                    range = "Neutral";
                } else if (totalValue >= -2) {
                    range = "Negative";
                } else {
                    range = "Very Negative";
                }
                
                if (player.id === 0) {
                    setMessage(`Your hand: ${range}`);
                    addLog(`Your hand: ${range}`);
                } else {
                    addLog(`${player.name} hand: ${range}`);
                }
            });
        }
        
        // Render Functions
        function renderGame() {
            renderPlayers();
            updateActionPanel();
            updateGameInfo();
        }
        
        function renderPlayers() {
            const container = document.getElementById('players-container');
            container.innerHTML = '';
            
            gameState.players.forEach(player => {
                const isCurrentPlayer = player.id === gameState.currentPlayerIndex;
                const isSelected = player.id === gameState.selectedTarget;
                const isYou = player.id === 0;
                
                const playerDiv = document.createElement('div');
                playerDiv.className = `player-card ${isCurrentPlayer ? 'active' : ''} ${isSelected ? 'selected-target' : ''}`;
                playerDiv.onclick = () => selectTarget(player.id);
                
                // Build cards HTML
                let cardsHTML = '';
                if (player.hand.length === 0) {
                    cardsHTML = '<div style="color: rgba(251, 191, 36, 0.5); text-align: center; padding: 20px;">No cards</div>';
                } else {
                    for (let i = 0; i < player.hand.length; i++) {
                        const card = player.hand[i];
                        const isSelected = isYou && gameState.selectedCardIndex === i;
                        
                        if (isYou) {
                            // YOUR cards - show back (you don't see them)
                            cardsHTML += `
                                <div class="potion-card back ${isSelected ? 'selected' : ''}" 
                                     onclick="event.stopPropagation(); selectCard(${i})">
                                    <div class="card-position">#${i + 1}</div>
                                    <div class="card-icon">üíß</div>
                                    <div class="card-label">?</div>
                                </div>
                            `;
                        } else {
                            // OTHER PLAYERS' cards - show front (you CAN see them!)
                            let icon, label, valueHTML;
                            
                            if (card === 'empty') {
                                icon = '‚ö™';
                                label = 'Empty';
                                valueHTML = '';
                            } else if (card === 'poison') {
                                icon = '‚ò†Ô∏è';
                                label = 'Poison';
                                valueHTML = '<div class="card-value">-1</div>';
                            } else if (card === 'deadly') {
                                icon = 'üíÄ';
                                label = 'Deadly';
                                valueHTML = '<div class="card-value">-3</div>';
                            } else if (card === 'healing') {
                                icon = '‚ú®';
                                label = 'Healing';
                                valueHTML = '<div class="card-value">+2</div>';
                            }
                            
                            cardsHTML += `
                                <div class="potion-card ${card}">
                                    <div class="card-position">#${i + 1}</div>
                                    <div class="card-icon">${icon}</div>
                                    <div class="card-label">${label}</div>
                                    ${valueHTML}
                                </div>
                            `;
                        }
                    }
                }
                
                playerDiv.innerHTML = `
                    <div class="player-header">
                        <div class="player-name">${player.name}</div>
                        <div class="player-health">${player.health}</div>
                    </div>
                    <div class="cards-container">
                        ${cardsHTML}
                    </div>
                    <div class="player-stats">
                        <span>Clues: ${player.clueTokens.filter(t => t).map((_, i) => 'üîÆ').join('')}${player.clueTokens.filter(t => !t).map((_, i) => '‚ö´').join('')}</span>
                        <span>Gadgets: ${player.gadgets.length}</span>
                    </div>
                `;
                
                container.appendChild(playerDiv);
            });
        }
        
        function updateActionPanel() {
            const isPlayerTurn = gameState.players[gameState.currentPlayerIndex].id === 0;
            const panel = document.getElementById('action-panel');
            const gadgetsSection = document.getElementById('gadgets-section');
            
            if (isPlayerTurn) {
                panel.style.display = 'block';
                const currentPlayer = gameState.players[0];
                const availableClues = currentPlayer.clueTokens.filter(t => t).length;
                document.getElementById('clues-remaining').textContent = availableClues;
                document.getElementById('clue-btn').disabled = availableClues === 0;
                document.getElementById('give-btn').disabled = gameState.selectedTarget === null;
                
                // Update hint
                let hint = '';
                if (gameState.selectedTarget === null) {
                    hint = '‚Üí Select a target player';
                } else {
                    hint = '‚Üí Click "Give Potion" to start gadget phase';
                }
                document.getElementById('action-hint').textContent = hint;
                
                // Show gadgets if player has any
                if (currentPlayer.gadgets.length > 0) {
                    gadgetsSection.style.display = 'block';
                    renderGadgets();
                } else {
                    gadgetsSection.style.display = 'none';
                }
            } else {
                panel.style.display = 'none';
                gadgetsSection.style.display = 'none';
            }
        }
        
        function renderGadgets() {
            const container = document.getElementById('gadgets-container');
            const player = gameState.players[0];
            
            container.innerHTML = player.gadgets.map((gadget) => `
                <div class="gadget-card">
                    <div class="gadget-icon">${gadget.icon}</div>
                    <div class="gadget-name">${gadget.name}</div>
                    <div class="gadget-desc">${gadget.desc}</div>
                    <div style="margin-top: 8px; font-size: 0.7rem; color: #a78bfa;">Used via popup</div>
                </div>
            `).join('');
        }
        
        function updateGameInfo() {
            document.getElementById('current-round').textContent = gameState.currentRound;
            document.getElementById('current-turn').textContent = gameState.currentTurn;
        }
        
        // Selection Functions
        function selectTarget(playerId) {
            if (gameState.players[gameState.currentPlayerIndex].id !== 0) return;
            
            gameState.selectedTarget = playerId;
            renderPlayers();
            updateActionPanel();
        }
        
        function selectCard(index) {
            if (gameState.players[gameState.currentPlayerIndex].id !== 0) return;
            
            gameState.selectedCardIndex = index;
            renderPlayers();
            updateActionPanel();
        }
        
        // Clue Functions
        function openClueModal() {
            const player = gameState.players[0];
            const availableClues = player.clueTokens.filter(t => t).length;
            if (availableClues === 0) return;
            
            document.getElementById('clue-modal').classList.add('active');
            document.getElementById('clue-step-1').style.display = 'block';
            document.getElementById('clue-step-2').style.display = 'none';
            document.getElementById('clue-answer').style.display = 'none';
        }
        
        function closeClueModal() {
            document.getElementById('clue-modal').classList.remove('active');
            gameState.clueType = null;
            gameState.cluePos1 = null;
            gameState.cluePos2 = null;
        }
        
        function selectClueType(type) {
            gameState.clueType = type;
            document.getElementById('clue-step-1').style.display = 'none';
            document.getElementById('clue-step-2').style.display = 'block';
            
            const player = gameState.players[0];
            const selector1 = document.getElementById('position-selector-1');
            const selector2 = document.getElementById('position-selector-2');
            const instruction = document.getElementById('clue-instruction');
            
            if (type === 'quality') {
                instruction.textContent = 'Confirm to check your hand quality again:';
                selector1.style.display = 'none';
                selector2.style.display = 'none';
            } else if (type === 'single') {
                instruction.textContent = 'Select which card to check:';
                selector1.style.display = 'flex';
                selector2.style.display = 'none';
                renderPositionSelector(selector1, 1);
            } else if (type === 'compare') {
                instruction.textContent = 'Select two cards to compare:';
                selector1.style.display = 'flex';
                selector2.style.display = 'flex';
                document.getElementById('position-selector-2').innerHTML = '<div style="text-align: center; width: 100%; color: #fcd34d; margin: 10px 0;">Second card:</div>';
                renderPositionSelector(selector1, 1);
                renderPositionSelector(selector2, 2);
            }
        }
        
        function renderPositionSelector(container, selectorNum) {
            const player = gameState.players[0];
            container.innerHTML = '';
            
            for (let i = 0; i < player.hand.length; i++) {
                const btn = document.createElement('button');
                btn.className = 'position-btn';
                btn.textContent = `#${i + 1}`;
                btn.onclick = () => selectPosition(i, selectorNum);
                
                if (selectorNum === 1 && gameState.cluePos1 === i) {
                    btn.classList.add('selected');
                } else if (selectorNum === 2 && gameState.cluePos2 === i) {
                    btn.classList.add('selected');
                }
                
                container.appendChild(btn);
            }
        }
        
        function selectPosition(pos, selectorNum) {
            if (selectorNum === 1) {
                gameState.cluePos1 = pos;
                renderPositionSelector(document.getElementById('position-selector-1'), 1);
            } else {
                gameState.cluePos2 = pos;
                renderPositionSelector(document.getElementById('position-selector-2'), 2);
            }
        }
        
        function backToClueType() {
            document.getElementById('clue-step-1').style.display = 'block';
            document.getElementById('clue-step-2').style.display = 'none';
            gameState.cluePos1 = null;
            gameState.cluePos2 = null;
        }
        
        function confirmClue() {
            const player = gameState.players[0];
            let answer = '';
            
            if (gameState.clueType === 'quality') {
                const totalValue = player.hand.reduce((sum, card) => sum + CARD_VALUES[card], 0);
                let range;
                if (totalValue >= 3) {
                    range = "Very Positive";
                } else if (totalValue >= 1) {
                    range = "Positive";
                } else if (totalValue === 0) {
                    range = "Neutral";
                } else if (totalValue >= -2) {
                    range = "Negative";
                } else {
                    range = "Very Negative";
                }
                answer = `Your hand quality: ${range}`;
            } else if (gameState.clueType === 'single') {
                if (gameState.cluePos1 === null) return;
                const card = player.hand[gameState.cluePos1];
                const type = card === 'empty' ? 'Empty' : 'Potion';
                answer = `Card #${gameState.cluePos1 + 1} is: ${type}`;
            } else if (gameState.clueType === 'compare') {
                if (gameState.cluePos1 === null || gameState.cluePos2 === null) return;
                const card1 = player.hand[gameState.cluePos1];
                const card2 = player.hand[gameState.cluePos2];
                const same = (card1 === 'empty' && card2 === 'empty') || 
                            (card1 !== 'empty' && card2 !== 'empty');
                answer = `Cards #${gameState.cluePos1 + 1} and #${gameState.cluePos2 + 1} are: ${same ? 'Same type' : 'Different types'}`;
            }
            
            // Use one clue token
            const tokenIndex = player.clueTokens.findIndex(t => t);
            if (tokenIndex !== -1) {
                player.clueTokens[tokenIndex] = false;
            }
            
            document.getElementById('clue-step-2').style.display = 'none';
            document.getElementById('clue-answer').style.display = 'block';
            document.getElementById('clue-answer-text').textContent = answer;
            
            addLog(`You used a clue. ${answer}`);
            renderPlayers();
            updateActionPanel();
        }
        
        // Game Logic - NEW TIMING SYSTEM
        function givePotion() {
            if (gameState.selectedTarget === null) {
                setMessage('Select a target first!');
                return;
            }
            
            const player = gameState.players[gameState.currentPlayerIndex];
            const target = gameState.players.find(p => p.id === gameState.selectedTarget);
            
            // Store action details WITHOUT card yet
            gameState.pendingAction = {
                giver: player,
                receiver: target,
                cardIndex: null,
                card: null,
                placedGadgets: [] // Array of {playerId, gadget, faceDown: true}
            };
            
            // Reset card selection
            gameState.selectedCardIndex = null;
            
            // Start gadget placement phase - ALL players can place gadgets
            startGadgetPlacementPhase();
        }
        
        function startGadgetPlacementPhase() {
            const { giver, receiver } = gameState.pendingAction;
            gameState.gadgetPlacementQueue = [];
            
            // Check if giver is targeting themselves
            const isSelfTarget = (giver.id === receiver.id);
            
            if (isSelfTarget) {
                // ALL players can place gadgets
                gameState.players.forEach(player => {
                    if (player.gadgets.length > 0) {
                        gameState.gadgetPlacementQueue.push(player.id);
                    }
                });
            } else {
                // Only giver and receiver can place gadgets
                if (giver.gadgets.length > 0) {
                    gameState.gadgetPlacementQueue.push(giver.id);
                }
                if (receiver.gadgets.length > 0 && receiver.id !== giver.id) {
                    gameState.gadgetPlacementQueue.push(receiver.id);
                }
            }
            
            if (gameState.gadgetPlacementQueue.length === 0) {
                // No one has gadgets, skip to card selection
                showCardSelectionPhase();
            } else {
                processNextGadgetPlacement();
            }
        }
        
        function processNextGadgetPlacement() {
            if (gameState.gadgetPlacementQueue.length === 0) {
                // All done, move to card selection
                showCardSelectionPhase();
                return;
            }
            
            const playerId = gameState.gadgetPlacementQueue[0];
            const player = gameState.players.find(p => p.id === playerId);
            
            // Show popup for human player, auto-place for AI
            if (player.id === 0) {
                // Human player - show popup
                showGadgetPlacementPopup(player);
            } else {
                // AI - auto place (30% chance)
                if (Math.random() < 0.3) {
                    const gadgetIndex = Math.floor(Math.random() * player.gadgets.length);
                    placeGadgetSilent(player.id, gadgetIndex);
                } else {
                    skipGadgetPlacement();
                }
            }
        }
        
        function placeGadgetSilent(playerId, gadgetIndex) {
            // Place gadget without popup, just log
            const player = gameState.players.find(p => p.id === playerId);
            const gadget = player.gadgets[gadgetIndex];
            
            // Place gadget face down
            gameState.pendingAction.placedGadgets.push({
                playerId: playerId,
                playerName: player.name,
                gadget: gadget,
                faceDown: true
            });
            
            // Remove from player's hand
            player.gadgets.splice(gadgetIndex, 1);
            
            addLog(`${player.name} placed a gadget face down üé¥`);
            
            // Remove from queue and continue
            gameState.gadgetPlacementQueue.shift();
            processNextGadgetPlacement();
        }
        
        function showGadgetPlacementPopup(player) {
            document.getElementById('gadget-use-title').textContent = 'Place a Gadget? (Face Down)';
            document.getElementById('gadget-use-subtitle').textContent = `${gameState.pendingAction.giver.name} ‚Üí ${gameState.pendingAction.receiver.name}. Place a gadget face down?`;
            
            const container = document.getElementById('gadget-use-options');
            container.innerHTML = player.gadgets.map((gadget, index) => `
                <div class="gadget-card usable" onclick="placeGadget(${player.id}, ${index})">
                    <div class="gadget-icon">${gadget.icon}</div>
                    <div class="gadget-name">${gadget.name}</div>
                    <div class="gadget-desc">${gadget.desc}</div>
                </div>
            `).join('');
            
            document.getElementById('gadget-use-modal').classList.add('active');
        }
        
        function placeGadget(playerId, gadgetIndex) {
            const player = gameState.players.find(p => p.id === playerId);
            const gadget = player.gadgets[gadgetIndex];
            
            // Place gadget face down
            gameState.pendingAction.placedGadgets.push({
                playerId: playerId,
                playerName: player.name,
                gadget: gadget,
                faceDown: true
            });
            
            // Remove from player's hand
            player.gadgets.splice(gadgetIndex, 1);
            
            addLog(`${player.name} placed a gadget face down üé¥`);
            
            document.getElementById('gadget-use-modal').classList.remove('active');
            
            // Remove from queue and continue
            gameState.gadgetPlacementQueue.shift();
            processNextGadgetPlacement();
        }
        
        function skipGadgetPlacement() {
            document.getElementById('gadget-use-modal').classList.remove('active');
            
            // Remove from queue and continue
            gameState.gadgetPlacementQueue.shift();
            processNextGadgetPlacement();
        }
        
        function showCardSelectionPhase() {
            const { giver } = gameState.pendingAction;
            
            if (giver.id === 0) {
                // Human player - show message to select card
                setMessage('Now select which card to give!');
                renderGame();
                // Wait for player to click a card
            } else {
                // AI - auto select
                const cardIndex = Math.floor(Math.random() * giver.hand.length);
                finishCardSelection(cardIndex);
            }
        }
        
        function selectCard(index) {
            if (gameState.players[gameState.currentPlayerIndex].id !== 0) return;
            
            // Check if we're in card selection phase after gadget placement
            if (gameState.pendingAction && gameState.pendingAction.cardIndex === null) {
                finishCardSelection(index);
            } else {
                // Normal selection before giving potion
                gameState.selectedCardIndex = index;
                renderPlayers();
                updateActionPanel();
            }
        }
        
        function finishCardSelection(cardIndex) {
            const { giver } = gameState.pendingAction;
            const card = giver.hand[cardIndex];
            
            gameState.pendingAction.cardIndex = cardIndex;
            gameState.pendingAction.card = card;
            
            // Remove card from hand
            giver.hand.splice(cardIndex, 1);
            gameState.usedDeck.push(card);
            
            renderGame();
            
            // Now reveal all face-down gadgets
            revealGadgets();
        }
        
        function revealGadgets() {
            const { placedGadgets } = gameState.pendingAction;
            
            if (placedGadgets.length === 0) {
                // No gadgets placed, go straight to card reveal
                calculateFinalEffect();
            } else {
                // Show gadget reveal
                showGadgetRevealModal();
            }
        }
        
        function showGadgetRevealModal() {
            const { placedGadgets } = gameState.pendingAction;
            
            // Reveal all gadgets
            placedGadgets.forEach(pg => pg.faceDown = false);
            
            const container = document.getElementById('gadget-selection');
            container.innerHTML = '<div style="text-align: center; grid-column: 1 / -1; margin-bottom: 15px; color: #fcd34d; font-size: 1.2rem;">Gadgets Revealed!</div>' +
                placedGadgets.map(pg => `
                <div style="background: rgba(30, 27, 75, 0.7); border: 2px solid #a78bfa; border-radius: 10px; padding: 15px;">
                    <div style="color: #fcd34d; font-weight: bold; margin-bottom: 5px;">${pg.playerName}</div>
                    <div class="gadget-icon" style="font-size: 2rem;">${pg.gadget.icon}</div>
                    <div class="gadget-name" style="color: #a78bfa;">${pg.gadget.name}</div>
                </div>
            `).join('');
            
            document.getElementById('gadget-modal').classList.add('active');
            
            // Log all revealed gadgets
            placedGadgets.forEach(pg => {
                addLog(`${pg.playerName} reveals: ${pg.gadget.name}`);
            });
            
            // Auto-close after 2 seconds
            setTimeout(() => {
                document.getElementById('gadget-modal').classList.remove('active');
                calculateFinalEffect();
            }, 2500);
        }
        
        function calculateFinalEffect() {
            const { giver, receiver, card, placedGadgets } = gameState.pendingAction;
            
            // Sort gadgets by priority (lower number = higher priority)
            const sortedGadgets = [...placedGadgets].sort((a, b) => a.gadget.priority - b.gadget.priority);
            
            let finalCard = card;
            let effect = CARD_VALUES[card];
            let actualReceiver = receiver;
            let gadgetsBroken = false;
            
            // Apply all gadget effects in priority order
            for (const pg of sortedGadgets) {
                // Check if Gadget Breaker was activated
                if (gadgetsBroken && pg.gadget.id !== 'breaker') {
                    addLog(`‚ùå ${pg.gadget.name} was destroyed by Gadget Breaker!`);
                    continue;
                }
                
                const result = applyPlacedGadget(pg.gadget, finalCard, effect, giver, actualReceiver, pg.playerName);
                finalCard = result.card;
                effect = result.effect;
                actualReceiver = result.receiver;
                
                // Check if this was Gadget Breaker
                if (pg.gadget.id === 'breaker') {
                    gadgetsBroken = true;
                }
            }
            
            // Show card reveal
            showCardReveal(giver, actualReceiver, finalCard, effect);
        }
        
        function applyPlacedGadget(gadget, card, effect, giver, receiver, playerName) {
            switch(gadget.id) {
                case 'breaker':
                    // Priority 1 - Destroys ALL other gadgets
                    addLog(`‚ùå Gadget Breaker: All other gadgets destroyed!`);
                    return { card, effect, receiver };
                    
                case 'swap':
                    // Priority 2
                    if (gameState.deck.length > 0) {
                        const newCard = gameState.deck.shift(); // Take FIRST card from deck
                        gameState.deck.push(card); // Put old card at end
                        const newEffect = CARD_VALUES[newCard];
                        addLog(`üîÑ Swap: ${card} ‚Üí ${newCard}!`);
                        return { card: newCard, effect: newEffect, receiver };
                    }
                    return { card, effect, receiver };
                    
                case 'distiller':
                    // Priority 3 - Discards card, nullifies Amplifier/Catalyst
                    addLog(`üí• Distiller: Card discarded, no effect!`);
                    return { card: 'empty', effect: 0, receiver: null }; // No target!
                    
                case 'amplifier':
                    // Priority 4
                    const doubled = effect * 2;
                    addLog(`‚ö° Amplifier: ${effect} ‚Üí ${doubled}!`);
                    return { card, effect: doubled, receiver };
                    
                case 'catalyst':
                    // Priority 4 - Hit additional player (picked by player who used gadget)
                    const others = gameState.players.filter(p => p.id !== giver.id && p.id !== receiver.id);
                    if (others.length > 0) {
                        // For now, pick random. In full implementation, player would choose before reveal.
                        const extraTarget = others[Math.floor(Math.random() * others.length)];
                        gameState.pendingAction.catalystTarget = extraTarget;
                        addLog(`üí• Catalyst by ${playerName}: ${extraTarget.name} will also be hit!`);
                    }
                    return { card, effect, receiver };
                    
                case 'reflect':
                    // Priority 4
                    addLog(`ü™û Reflect: Sent back to ${giver.name}!`);
                    return { card, effect, receiver: giver };
                    
                case 'immuno':
                    // Priority 4
                    let newEffect = effect;
                    if (effect < 0) {
                        newEffect = 0;
                        addLog(`üõ°Ô∏è Immuno: Negative nullified (${effect} ‚Üí 0)!`);
                    } else if (effect > 0) {
                        newEffect = 1;
                        addLog(`üõ°Ô∏è Immuno: Positive reduced (${effect} ‚Üí 1)!`);
                    }
                    return { card, effect: newEffect, receiver };
                    
                case 'double-turn':
                    // Priority 5
                    addLog(`‚è© Double Turn: ${playerName} gets extra turn!`);
                    gameState.pendingAction.doubleTurn = gameState.players.find(p => p.name === playerName).id;
                    return { card, effect, receiver };
                    
                default:
                    return { card, effect, receiver };
            }
        }
        
        function showCardReveal(giver, receiver, card, effect) {
            const icons = { empty: '‚ö™', poison: '‚ò†Ô∏è', deadly: 'üíÄ', healing: '‚ú®' };
            const labels = { empty: 'Empty', poison: 'Poison', deadly: 'Deadly Poison', healing: 'Healing' };
            
            // Handle Distiller case (no receiver)
            if (receiver === null) {
                document.getElementById('reveal-title').textContent = `${giver.name} ‚Üí Discarded`;
            } else {
                document.getElementById('reveal-title').textContent = `${giver.name} ‚Üí ${receiver.name}`;
            }
            
            // Show the card
            const cardHTML = `
                <div class="potion-card ${card}" style="width: 100px; height: 140px;">
                    <div class="card-icon" style="font-size: 3rem;">${icons[card]}</div>
                    <div class="card-label" style="font-size: 1rem;">${labels[card]}</div>
                    ${card !== 'empty' ? `<div class="card-value" style="font-size: 1.5rem;">${effect > 0 ? '+' : ''}${effect}</div>` : ''}
                </div>
            `;
            document.getElementById('revealed-card').innerHTML = cardHTML;
            
            // Show effect
            if (receiver === null) {
                document.getElementById('reveal-effect').textContent = `Card discarded - No effect`;
            } else {
                document.getElementById('reveal-effect').textContent = `Effect: ${effect > 0 ? '+' : ''}${effect} points`;
            }
            
            // Store what to do after reveal
            gameState.pendingReveal = { giver, receiver, card, effect };
            
            document.getElementById('card-reveal-modal').classList.add('active');
        }
        
        function closeCardReveal() {
            document.getElementById('card-reveal-modal').classList.remove('active');
            
            const { giver, receiver, card, effect } = gameState.pendingReveal;
            
            // Check if Distiller was used (receiver === null means no target)
            if (receiver === null) {
                addLog(`${giver.name} played ${card}. Distiller: Card discarded, no effect.`);
                renderGame();
                nextTurn();
                return;
            }
            
            // Apply effect to receiver
            receiver.health += effect;
            addLog(`${giver.name} gave ${card} to ${receiver.name}. Effect: ${effect > 0 ? '+' : ''}${effect}. ${receiver.name} now has ${receiver.health} points.`);
            
            // Check if Catalyst was used (extra target)
            if (gameState.pendingAction && gameState.pendingAction.catalystTarget) {
                const extraTarget = gameState.pendingAction.catalystTarget;
                extraTarget.health += effect;
                addLog(`üí• Catalyst: ${extraTarget.name} also receives ${effect > 0 ? '+' : ''}${effect}! Now has ${extraTarget.health} points.`);
            }
            
            renderGame();
            
            // Check if empty card - TARGET gets gadget (not the giver!)
            if (card === 'empty') {
                showGadgetSelection(receiver);
            } else {
                // Check for double turn
                if (gameState.pendingAction && gameState.pendingAction.doubleTurn !== undefined) {
                    const doubleTurnPlayer = gameState.players.find(p => p.id === gameState.pendingAction.doubleTurn);
                    addLog(`‚è© ${doubleTurnPlayer.name} gets another turn!`);
                    // Don't change currentPlayerIndex
                    gameState.pendingAction.doubleTurn = undefined;
                    setMessage(`${doubleTurnPlayer.name}'s extra turn!`);
                    renderGame();
                    if (doubleTurnPlayer.isAI) {
                        setTimeout(playAITurn, 1000);
                    }
                } else {
                    nextTurn();
                }
            }
        }
        
        function showGadgetSelection(receivingPlayer) {
            const twoGadgets = [...GADGETS].sort(() => Math.random() - 0.5).slice(0, 2);
            
            // If AI is receiving, auto-select
            if (receivingPlayer.isAI) {
                const chosenGadget = twoGadgets[Math.floor(Math.random() * 2)];
                receivingPlayer.gadgets.push(chosenGadget);
                addLog(`${receivingPlayer.name} gained gadget: ${chosenGadget.name}`);
                setTimeout(() => nextTurn(), 500);
                return;
            }
            
            // If human player is receiving, show modal
            const container = document.getElementById('gadget-selection');
            
            container.innerHTML = `
                <div style="text-align: center; grid-column: 1 / -1; margin-bottom: 15px; color: #fcd34d; font-size: 1.2rem;">
                    ${receivingPlayer.name === 'You' ? 'You receive' : receivingPlayer.name + ' receives'} a gadget!
                </div>
            ` + twoGadgets.map(gadget => `
                <div class="gadget-card selectable" onclick='selectGadgetForPlayer(${JSON.stringify(gadget)}, ${receivingPlayer.id})'>
                    <div class="gadget-icon">${gadget.icon}</div>
                    <div class="gadget-name">${gadget.name}</div>
                    <div class="gadget-desc">${gadget.desc}</div>
                </div>
            `).join('');
            
            document.getElementById('gadget-modal').classList.add('active');
        }
        
        function selectGadgetForPlayer(gadget, playerId) {
            const player = gameState.players.find(p => p.id === playerId);
            player.gadgets.push(gadget);
            
            addLog(`${player.name} gained gadget: ${gadget.name}`);
            
            document.getElementById('gadget-modal').classList.remove('active');
            
            // If it was AI's turn, continue; if player's turn and they gave to themselves, let them continue
            if (player.isAI || playerId === 0) {
                setTimeout(() => nextTurn(), 500);
            } else {
                nextTurn();
            }
        }
        
        function useGadget(gadgetIndex) {
            const player = gameState.players[0];
            const gadget = player.gadgets[gadgetIndex];
            
            if (!gadget) return;
            
            // Store gadget effect for next action
            player.pendingGadgetEffect = gadget.id;
            
            // Remove gadget from inventory
            player.gadgets.splice(gadgetIndex, 1);
            
            addLog(`You activated: ${gadget.name}`);
            setMessage(`Gadget activated: ${gadget.name}. Now select target and card.`);
            
            renderGame();
        }
        
        function applyGadgetEffect(player, target, card, effect) {
            const gadgetId = player.pendingGadgetEffect;
            
            if (!gadgetId) {
                return effect; // No gadget, return normal effect
            }
            
            player.pendingGadgetEffect = null; // Clear after use
            
            switch(gadgetId) {
                case 'distiller':
                    addLog(`Distiller activated: Card transformed to Empty!`);
                    return 0; // Transform to empty
                    
                case 'amplifier':
                    const doubled = effect * 2;
                    addLog(`Amplifier activated: Effect doubled (${effect} ‚Üí ${doubled})!`);
                    return doubled;
                    
                case 'partial-shield':
                    if (target.id === player.id) {
                        const halved = Math.floor(effect / 2);
                        addLog(`Partial Shield activated: Effect halved (${effect} ‚Üí ${halved})!`);
                        return halved;
                    }
                    return effect;
                    
                case 'immunity':
                    if (target.id === player.id && card !== 'empty') {
                        addLog(`Immunity Shield activated: Potion blocked!`);
                        return 0;
                    }
                    return effect;
                
                case 'reflect':
                case 'redirect':
                case 'double-turn':
                case 'nullifier':
                case 'swap':
                case 'catalyst':
                case 'shared-chalice':
                    addLog(`${gadgetId} activated (complex interaction - basic version)!`);
                    return effect;
                    
                default:
                    return effect;
            }
        }
        
        function nextTurn() {
            const allHandsEmpty = gameState.players.every(p => p.hand.length === 0);
            
            if (allHandsEmpty) {
                if (gameState.currentTurn === 1) {
                    startTurn2();
                } else {
                    endRound();
                }
            } else {
                gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
                renderGame();
                
                const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                
                // Calculate range from INITIAL total (doesn't change during turn)
                const totalValue = currentPlayer.initialTotal || 0;
                let range;
                if (totalValue >= 3) {
                    range = "Very Positive";
                } else if (totalValue >= 1) {
                    range = "Positive";
                } else if (totalValue === 0) {
                    range = "Neutral";
                } else if (totalValue >= -2) {
                    range = "Negative";
                } else {
                    range = "Very Negative";
                }
                
                if (currentPlayer.isAI) {
                    setMessage(`${currentPlayer.name}'s turn (${range})...`);
                    setTimeout(playAITurn, 1500);
                } else {
                    setMessage(`Your turn! Hand: ${range}`);
                }
            }
        }
        
        function startTurn2() {
            // Deal new hands from shuffled deck
            dealNewHands();
            
            // NOTE: Clue tokens do NOT reset between turns, only at end of round!
            
            gameState.usedDeck = [];
            gameState.currentTurn = 2;
            gameState.currentPlayerIndex = 0;
            
            addLog('Turn 2 begins!');
            setMessage('Turn 2 - Your turn!');
            announcePlayerPotions();
            renderGame();
        }
        
        function endRound() {
            if (gameState.currentRound === MAX_ROUNDS) {
                showGameEnd();
            } else {
                showRoundEnd();
            }
        }
        
        function showRoundEnd() {
            document.getElementById('round-number').textContent = gameState.currentRound;
            
            const scoresDiv = document.getElementById('round-scores');
            const sorted = [...gameState.players].sort((a, b) => b.health - a.health);
            
            scoresDiv.innerHTML = sorted.map(p => `
                <div style="display: flex; justify-content: space-between; padding: 10px; margin: 5px 0; background: rgba(30, 27, 75, 0.5); border-radius: 8px;">
                    <span style="color: #fcd34d; font-weight: bold;">${p.name}</span>
                    <span style="color: #fff; font-weight: bold;">${p.health} points</span>
                </div>
            `).join('');
            
            document.getElementById('round-end-modal').classList.add('active');
        }
        
        function nextRound() {
            document.getElementById('round-end-modal').classList.remove('active');
            
            gameState.currentRound++;
            gameState.currentTurn = 1;
            gameState.currentPlayerIndex = 0;
            
            dealNewHands();
            
            gameState.players.forEach((player) => {
                player.clueTokens = [true, true, true, true]; // Reset clue tokens (4 per round)
                player.gadgets = [];
            });
            
            gameState.usedDeck = [];
            
            addLog(`Round ${gameState.currentRound} begins!`);
            setMessage(`Round ${gameState.currentRound} - Your turn!`);
            announcePlayerPotions();
            renderGame();
        }
        
        function showGameEnd() {
            const scoresDiv = document.getElementById('final-scores');
            const sorted = [...gameState.players].sort((a, b) => b.health - a.health);
            
            scoresDiv.innerHTML = sorted.map((p, i) => `
                <div style="display: flex; justify-content: space-between; padding: 15px; margin: 10px 0; 
                     background: ${i === 0 ? 'rgba(251, 191, 36, 0.3)' : 'rgba(30, 27, 75, 0.5)'}; 
                     border: ${i === 0 ? '2px solid #fbbf24' : 'none'}; border-radius: 10px;">
                    <span style="color: ${i === 0 ? '#fcd34d' : '#fbbf24'}; font-weight: bold; font-size: 1.2rem;">
                        ${i === 0 ? 'üëë ' : ''}${p.name}
                    </span>
                    <span style="color: #fff; font-weight: bold; font-size: 1.2rem;">${p.health} points</span>
                </div>
            `).join('');
            
            document.getElementById('game-end-modal').classList.add('active');
        }
        
        // AI Logic
        function playAITurn() {
            const player = gameState.players[gameState.currentPlayerIndex];
            const availableClues = player.clueTokens.filter(t => t).length;
            
            // AI randomly decides to use clue
            if (availableClues > 0 && Math.random() > 0.5) {
                // Use a random clue token
                setTimeout(() => {
                    const tokenIndex = player.clueTokens.findIndex(t => t);
                    if (tokenIndex !== -1) {
                        player.clueTokens[tokenIndex] = false;
                    }
                    addLog(`${player.name} used a clue.`);
                    continueAITurn();
                }, 800);
            } else {
                continueAITurn();
            }
        }
        
        function continueAITurn() {
            const player = gameState.players[gameState.currentPlayerIndex];
            
            // AI chooses target (60% self, 40% random other)
            const targetSelf = Math.random() < 0.6;
            let target;
            if (targetSelf) {
                target = player;
            } else {
                const others = gameState.players.filter(p => p.id !== player.id);
                target = others[Math.floor(Math.random() * others.length)];
            }
            
            setTimeout(() => {
                // Store action details WITHOUT card yet
                gameState.pendingAction = {
                    giver: player,
                    receiver: target,
                    cardIndex: null,
                    card: null,
                    placedGadgets: []
                };
                
                // Start gadget placement for all players
                gameState.gadgetPlacementQueue = [];
                
                gameState.players.forEach(p => {
                    if (p.gadgets.length > 0) {
                        gameState.gadgetPlacementQueue.push(p.id);
                    }
                });
                
                if (gameState.gadgetPlacementQueue.length === 0) {
                    // No gadgets, pick card immediately
                    const cardIndex = Math.floor(Math.random() * player.hand.length);
                    finishCardSelection(cardIndex);
                } else {
                    processNextGadgetPlacement();
                }
            }, 1000);
        }
        
        // Utility Functions
        function addLog(text) {
            const log = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `${new Date().toLocaleTimeString()}: ${text}`;
            log.prepend(entry);
            
            // Keep only last 20 entries
            while (log.children.length > 20) {
                log.removeChild(log.lastChild);
            }
        }
        
        function setMessage(text) {
            document.getElementById('message').textContent = text;
        }
        
        // Initialize
        selectPlayers(2);
    </script>
</body>
</html>
